# database.py
import sqlite3
import os
import json

class Database:
    def __init__(self, db_path="songs.db"):
        """初始化数据库类，设置数据库路径"""
        self.db_path = db_path
    
    def get_connection(self):
        """获取数据库连接"""
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row  # 方便后续以字典形式获取数据
        return conn
    
    def init_db(self, reset=False):
        """初始化数据库：创建必要的表并插入示例数据
        
        Args:
            reset: 如果为True，则删除现有数据库并重新创建
        """
        if reset and os.path.exists(self.db_path):
            os.remove(self.db_path)
        
        # 创建所有表
        self.create_users_table()
        self.create_songs_table()
        self.create_prizes_table()
        self.create_cotton_candy_table()
        
        # 插入初始数据
        self.seed_users_data()
        self.seed_songs_data()
    
    def create_users_table(self):
        """创建用户表"""
        conn = self.get_connection()
        cur = conn.cursor()
        cur.execute("""
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT UNIQUE NOT NULL,
                password TEXT NOT NULL,
                bilibili_uid TEXT,
                is_admin INTEGER DEFAULT 0
            )
        """)
        # 在创建唯一索引前进行数据清理：
        # 1) 将空字符串的 UID 归一化为 NULL，避免因 "" 被视为有效值而触发唯一冲突
        cur.execute("""
            UPDATE users
            SET bilibili_uid = NULL
            WHERE bilibili_uid IS NOT NULL AND TRIM(bilibili_uid) = ''
        """)
        # 2) 处理重复的非空 UID：保留最小 id 的一条，其余置为 NULL
        cur.execute("""
            SELECT bilibili_uid
            FROM users
            WHERE bilibili_uid IS NOT NULL
            GROUP BY bilibili_uid
            HAVING COUNT(*) > 1
        """)
        dups = [row[0] for row in cur.fetchall()]
        for uid in dups:
            cur.execute("SELECT id FROM users WHERE bilibili_uid = ? ORDER BY id ASC", (uid,))
            ids = [r[0] for r in cur.fetchall()]
            # 保留第一条，其余置空
            for duplicate_id in ids[1:]:
                cur.execute("UPDATE users SET bilibili_uid = NULL WHERE id = ?", (duplicate_id,))

        # 为 bilibili_uid 建立唯一索引（如不存在）。
        # 说明：SQLite 对 NULL 值在唯一索引中不判定为冲突，因此允许现有空值存在；
        # 新注册时在应用层强制必填即可实现“必填+唯一”的语义。
        cur.execute("""
            CREATE UNIQUE INDEX IF NOT EXISTS idx_users_bilibili_uid_unique
            ON users (bilibili_uid)
        """)
        conn.commit()
        conn.close()
    
    def create_songs_table(self):
        """创建歌曲表"""
        conn = self.get_connection()
        cur = conn.cursor()
        cur.execute("""
        CREATE TABLE IF NOT EXISTS songs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title TEXT NOT NULL,
            artist TEXT NOT NULL,
            album TEXT,
            genre TEXT,
            year INTEGER,
            meta_data TEXT,
            tags TEXT
        )
        """)
        conn.commit()
        conn.close()
    
    def create_prizes_table(self):
        """创建奖品表"""
        conn = self.get_connection()
        cur = conn.cursor()
        cur.execute("""
            CREATE TABLE IF NOT EXISTS prizes (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                name TEXT NOT NULL,
                probability REAL NOT NULL,
                image TEXT
            )
        """)
        conn.commit()
        conn.close()
    
    def create_cotton_candy_table(self):
        """创建棉花糖表"""
        conn = self.get_connection()
        cur = conn.cursor()
        cur.execute("""
            CREATE TABLE IF NOT EXISTS cotton_candy (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                sender TEXT NOT NULL,
                title TEXT,
                content TEXT NOT NULL,
                create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                read INTEGER DEFAULT 0
            )
        """)
        conn.commit()
        conn.close()
    
    def seed_users_data(self):
        """插入默认用户数据"""
        conn = self.get_connection()
        cur = conn.cursor()
        
        # 检查是否已存在管理员用户
        cur.execute("SELECT id FROM users WHERE username = ?", ("tofu",))
        if not cur.fetchone():
            # 插入默认管理员
            admin_users = [
                ("tofu", "5b5f2a30642928dc7f96079f72a4ac0f", "3546719987960278", 1),
                ("xiaotu", "5b5f2a30642928dc7f96079f72a4ac0f", "3915536", 1)
            ]
            cur.executemany("""
                INSERT INTO users (username, password, bilibili_uid, is_admin)
                VALUES (?, ?, ?, ?)
            """, admin_users)
            conn.commit()
        
        conn.close()
    
    def seed_songs_data(self):
        """插入示例歌曲数据"""
        conn = self.get_connection()
        cur = conn.cursor()
        
        # 检查是否已存在歌曲数据
        cur.execute("SELECT COUNT(*) FROM songs")
        count = cur.fetchone()[0]
        
        if count == 0:
            # 插入示例歌曲数据
            example_songs = [
                ("太聪明", "陈绮贞", "Groupies 吉他手", "民谣/独立流行", 2002, '{"duration": "4:06"}', "华语,独立,流行,文艺"),
                ("after 17", "陈绮贞", "after 17（单曲）", "民谣/独立流行", 2004, '{"duration": "4:03"}', "华语,单曲,独立,青春"),
                ("还是会寂寞", "陈绮贞", "还是会寂寞", "民谣/独立流行", 2000, '{"duration": "5:14"}', "华语,早期,民谣,抒情"),
                ("私奔到月球", "五月天 feat. 陈绮贞", "离开地球表面 Jump!", "流行摇滚", 2007, '{"duration": "4:00"}', "华语,合作,情歌,浪漫"),
                ("我喜欢上你时的内心活动", "陈绮贞", "《喜欢你》电影原声带", "流行/原声带", 2017, '{"duration": "4:29"}', "华语,电影主题曲,情歌,浪漫"),
                ("旅行的意义", "陈绮贞", "华丽的冒险", "民谣/独立流行", 2005, '{"duration": "4:42"}', "华语,民谣,旅行,文青"),
                ("鱼", "陈绮贞", "太阳", "民谣/独立流行", 2009, '{"duration": "4:10"}', "华语,民谣,自然,清新"),
                ("告诉我", "陈绮贞", "还是会寂寞", "民谣/独立流行", 2000, '{"duration": "4:23"}', "华语,独立,内省,思考"),
                ("表面的和平", "陈绮贞", "华丽的冒险", "民谣/独立流行", 2005, '{"duration": "4:15"}', "华语,文艺,民谣,内省"),
                ("下个星期去英国", "陈绮贞", "太阳", "民谣/独立流行", 2009, '{"duration": "3:50"}', "华语,旅行,轻快,民谣"),
                ("华丽的冒险", "陈绮贞", "华丽的冒险", "民谣/独立流行", 2005, '{"duration": "4:40"}', "华语,主打,民谣,冒险"),
                ("太阳", "陈绮贞", "太阳", "民谣/独立流行", 2009, '{"duration": "4:11"}', "华语,民谣,阳光,深情"),
                ("烟火", "陈绮贞", "太阳", "民谣/独立流行", 2009, '{"duration": "4:22"}', "华语,摇滚,情感,夜色"),
                ("花的姿态", "陈绮贞", "华丽的冒险", "民谣/独立流行", 2005, '{"duration": "3:58"}', "华语,文艺,民谣,花"),
                ("太多", "陈绮贞", "华丽的冒险", "民谣/独立流行", 2005, '{"duration": "4:26"}', "华语,民谣,隐喻,诗意"),
                ("（失眠前）我想记得的47件事", "陈绮贞", "几米《地下铁》音乐剧原声带", "原声带", 2004, '{"duration": "4:19"}', "华语,原声,戏剧,诗意"),
                ("倔强爱情的胜利", "陈绮贞", "太阳", "民谣/独立流行", 2009, '{"duration": "4:07"}', "华语,民谣,倔强,爱情"),
                ("情歌", "梁静茹", "亲亲", "C-Pop", 2007, '{"duration": "4:18"}', "华语,情歌,抒情,流行"),
                ("勇气", "梁静茹", "勇气", "C-Pop", 2000, '{"duration": "4:50"}', "华语,经典,情歌,流行"),
                ("会呼吸的痛", "梁静茹", "亲亲", "C-Pop", 2007, '{"duration": "4:19"}', "华语,疗愈,抒情,流行"),
                ("暖暖", "梁静茹", "亲亲", "C-Pop", 2007, '{"duration": "4:22"}', "华语,温暖,流行,甜美"),
                ("可惜不是你", "梁静茹", "丝路", "C-Pop", 2005, '{"duration": "4:29"}', "华语,情歌,抒情,感伤"),
                ("宁夏", "梁静茹", "崇拜", "C-Pop", 2007, '{"duration": "4:15"}', "华语,轻快,民谣,旅行"),
                ("分手快乐", "梁静茹", "美丽人生", "C-Pop", 2002, '{"duration": "4:10"}', "华语,疗愈,分手,流行"),
                ("给未来的自己", "梁静茹", "崇拜", "C-Pop", 2007, '{"duration": "4:12"}', "华语,励志,温暖,流行"),
                ("小手拉大手", "梁静茹", "崇拜", "C-Pop", 2007, '{"duration": "3:55"}', "华语,甜美,可爱,流行"),
                ("崇拜", "梁静茹", "崇拜", "C-Pop", 2007, '{"duration": "4:23"}', "华语,情歌,自信,流行"),
                ("爱你不是两三天", "梁静茹", "闪亮的星", "C-Pop", 2001, '{"duration": "4:25"}', "华语,情歌,甜蜜,流行"),
                ("夜夜夜夜", "梁静茹", "C'est La Vie", "C-Pop", 2001, '{"duration": "4:48"}', "华语,翻唱,经典,抒情"),
                ("燕尾蝶", "梁静茹", "燕尾蝶", "C-Pop", 2004, '{"duration": "4:22"}', "华语,抒情,电影插曲,文艺"),
                ("失忆", "梁静茹", "丝路", "C-Pop", 2005, '{"duration": "4:21"}', "华语,疗愈,感伤,抒情"),
                ("明明很爱你", "梁静茹", "丝路", "C-Pop", 2005, '{"duration": "4:11"}', "华语,情歌,苦恋,流行"),
                ("不是我不明白", "梁静茹", "美丽人生", "C-Pop", 2002, '{"duration": "4:08"}', "华语,情感,流行,抒情"),
                ("亲亲", "梁静茹", "亲亲", "C-Pop", 2007, '{"duration": "4:18"}', "华语,甜美,浪漫,流行"),
                ("还是好朋友", "梁静茹", "亲亲", "C-Pop", 2007, '{"duration": "4:07"}', "华语,友情,情歌,淡淡的忧伤"),
                ("可乐戒指", "梁静茹", "丝路", "C-Pop", 2005, '{"duration": "4:00"}', "华语,情歌,可爱,甜蜜"),
                ("修炼爱情", "林俊杰", "新地球", "C-Pop", 2014, '{"duration": "4:53"}', "华语,情歌,深情,流行"),
                ("愿与愁", "林俊杰", "JJ20", "C-Pop", 2022, '{"duration": "4:40"}', "华语,抒情,流行,情感"),
                ("达尔文", "林俊杰", "JJ陆", "C-Pop", 2008, '{"duration": "4:39"}', "华语,情感,哲理,流行"),
                ("美人鱼", "林俊杰", "她说", "C-Pop", 2010, '{"duration": "4:29"}', "华语,童话,情歌,流行"),
                ("可惜没如果", "林俊杰", "和自己对话", "C-Pop", 2015, '{"duration": "4:33"}', "华语,情歌,遗憾,流行"),
                ("我还想她", "林俊杰", "JJ陆", "C-Pop", 2008, '{"duration": "4:20"}', "华语,失恋,抒情,流行"),
                ("不为谁而作的歌", "林俊杰", "和自己对话", "C-Pop", 2015, '{"duration": "4:36"}', "华语,自我,情歌,流行"),
                ("那些你很冒险的梦", "林俊杰", "学不会", "C-Pop", 2011, '{"duration": "4:50"}', "华语,青春,回忆,情感"),
                ("新地球", "林俊杰", "新地球", "C-Pop", 2014, '{"duration": "3:57"}', "华语,创新,概念,电子"),
                ("浪漫血液", "林俊杰", "和自己对话", "C-Pop", 2015, '{"duration": "3:49"}', "华语,浪漫,情歌,轻快"),
                ("当你", "林俊杰", "编号89757", "C-Pop", 2004, '{"duration": "4:23"}', "华语,告白,情歌,经典"),
                ("爱笑的眼睛", "林俊杰", "编号89757", "C-Pop", 2004, '{"duration": "4:16"}', "华语,甜美,微笑,抒情"),
                ("冻结", "林俊杰", "第二天堂", "C-Pop", 2004, '{"duration": "4:15"}', "华语,情歌,冬日,流行"),
                ("醉赤壁", "林俊杰", "JJ陆", "C-Pop", 2008, '{"duration": "4:37"}', "华语,古风,情歌,抒情"),
                ("爱不会绝迹", "林俊杰", "第二天堂", "C-Pop", 2004, '{"duration": "4:09"}', "华语,情歌,信念,流行"),
                ("期待爱", "林俊杰", "编号89757", "C-Pop", 2004, '{"duration": "4:26"}', "华语,青春,情感,流行"),
                ("交换余生", "林俊杰", "幸存者", "C-Pop", 2021, '{"duration": "4:02"}', "华语,情歌,承诺,流行"),
                ("黑暗骑士", "林俊杰", "学不会", "C-Pop", 2011, '{"duration": "4:13"}', "华语,暗黑,故事,情感"),
                ("她说", "林俊杰", "她说", "C-Pop", 2010, '{"duration": "4:15"}', "华语,叙事,情歌,流行"),
                ("被风吹过的夏天", "林俊杰 feat. 金莎", "编号89757", "C-Pop", 2005, '{"duration": "4:10"}', "华语,清新,夏天,轻快"),
                ("想见你想见你想见你", "林俊杰", "想见你想见你想见你", "C-Pop", 2020, '{"duration": "4:17"}', "华语,OST,思念,情歌"),
                ("无与伦比的美丽", "苏打绿", "无与伦比的美丽", "C-Pop", 2007, '{"duration": "4:44"}', "华语,清新,文艺,流行"),
                ("喜欢寂寞", "苏打绿", "小宇宙", "C-Pop", 2006, '{"duration": "4:14"}', "华语,独立,抒情,流行"),
                ("你被写在我的歌里", "苏打绿", "秋：故事", "C-Pop", 2013, '{"duration": "4:08"}', "华语,情歌,深情,文艺"),
                ("他夏了夏天", "苏打绿", "小宇宙", "C-Pop", 2006, '{"duration": "4:10"}', "华语,青春,轻快,清新"),
                ("当我们一起走过", "苏打绿", "秋：故事", "C-Pop", 2013, '{"duration": "4:02"}', "华语,情感,温暖,抒情"),
                ("十年一刻", "苏打绿", "秋：故事", "C-Pop", 2013, '{"duration": "4:38"}', "华语,纪念,深情,流行"),
                ("迟到千年", "苏打绿", "迟到千年", "C-Pop", 2005, '{"duration": "4:06"}', "华语,情感,抒情,流行"),
                ("是我的海", "苏打绿", "小宇宙", "C-Pop", 2006, '{"duration": "4:20"}', "华语,抒情,大海,深情"),
                ("狂热", "苏打绿", "小宇宙", "C-Pop", 2006, '{"duration": "4:03"}', "华语,热情,电子,文艺"),
                ("你喔", "苏打绿", "秋：故事", "C-Pop", 2013, '{"duration": "4:12"}', "华语,亲密,情歌,流行"),
                ("被雨伤透", "苏打绿", "秋：故事", "C-Pop", 2013, '{"duration": "4:19"}', "华语,悲伤,雨天,抒情"),
                ("我知道", "By2", "成人礼", "C-Pop", 2011, '{"duration": "4:06"}', "华语,青春,成长,流行"),
                ("爱丫爱丫", "By2", "Twins", "C-Pop", 2008, '{"duration": "3:53"}', "华语,甜美,可爱,流行"),
                ("不够成熟", "By2", "成人礼", "C-Pop", 2011, '{"duration": "4:02"}', "华语,成长,情感,流行"),
                ("一样爱着你", "By2", "成人礼", "C-Pop", 2011, '{"duration": "3:58"}', "华语,情歌,深情,流行"),
                ("勇敢", "By2", "成人礼", "C-Pop", 2011, '{"duration": "4:15"}', "华语,励志,青春,流行"),
                ("匿名的好友", "杨丞琳", "任意门", "C-Pop", 2005, '{"duration": "4:07"}', "华语,友情,情感,流行"),
                ("雨爱", "杨丞琳", "雨爱", "C-Pop", 2010, '{"duration": "4:13"}', "华语,抒情,雨天,流行"),
                ("带我走", "杨丞琳", "半熟宣言", "C-Pop", 2008, '{"duration": "4:22"}', "华语,旅行,情感,流行"),
                ("暧昧", "杨丞琳", "暧昧", "C-Pop", 2005, '{"duration": "4:15"}', "华语,暧昧,情歌,流行"),
                ("左边", "杨丞琳", "暧昧", "C-Pop", 2005, '{"duration": "4:10"}', "华语,情感,失恋,流行"),
                ("理想情人", "杨丞琳", "暧昧", "C-Pop", 2005, '{"duration": "3:58"}', "华语,情歌,理想,流行"),
                ("红色高跟鞋", "蔡健雅", "若你碰到他", "C-Pop", 2009, '{"duration": "4:20"}', "华语,文艺,抒情,流行"),
                ("Letting Go", "蔡健雅", "Goodbye & Hello", "C-Pop", 2007, '{"duration": "4:18"}', "华语,英文,自我,流行"),
                ("越来越不懂", "蔡健雅", "若你碰到他", "C-Pop", 2009, '{"duration": "4:08"}', "华语,情感,思考,流行"),
                ("思念是一种病", "蔡健雅", "T-time", "C-Pop", 2006, '{"duration": "4:09"}', "华语,思念,民谣,流行"),
                ("空白格", "蔡健雅", "若你碰到他", "C-Pop", 2009, '{"duration": "4:11"}', "华语,失恋,抒情,流行"),
                ("被驯服的象", "蔡健雅", "Goodbye & Hello", "C-Pop", 2007, '{"duration": "4:14"}', "华语,情感,深情,流行"),
                ("无底洞", "蔡健雅", "无底洞", "C-Pop", 2005, '{"duration": "4:12"}', "华语,深情,抒情,流行"),
                ("第一次爱的人", "王心凌", "Cyndi with U", "C-Pop", 2005, '{"duration": "4:01"}', "华语,甜美,情歌,流行"),
                ("爱你", "王心凌", "爱你", "C-Pop", 2004, '{"duration": "3:45"}', "华语,甜美,经典,流行"),
                ("黄昏晓", "王心凌", "黏黏²", "C-Pop", 2012, '{"duration": "4:10"}', "华语,抒情,轻快,流行"),
                ("大眠", "王心凌", "敢要敢不要", "C-Pop", 2019, '{"duration": "4:15"}', "华语,失恋,抒情,流行"),
                ("彩虹的微笑", "王心凌", "Cyndi with U", "C-Pop", 2005, '{"duration": "3:59"}', "华语,甜美,活力,流行"),
                ("那年夏天宁静的海", "王心凌", "Cyndi with U", "C-Pop", 2005, '{"duration": "4:06"}', "华语,抒情,夏天,流行"),
                ("花的嫁纱", "王心凌", "黏黏²", "C-Pop", 2012, '{"duration": "4:12"}', "华语,抒情,婚礼,流行"),
                ("我怀念的", "孙燕姿", "逆光", "C-Pop", 2007, '{"duration": "4:50"}', "华语,抒情,感伤,流行"),
                ("遇见", "孙燕姿", "遇见", "C-Pop", 2003, '{"duration": "4:30"}', "华语,电影原声,感动,流行"),
                ("开始懂了", "孙燕姿", "Stefanie", "C-Pop", 2004, '{"duration": "4:20"}', "华语,情感,成长,流行"),
                ("雨天", "孙燕姿", "逆光", "C-Pop", 2007, '{"duration": "4:15"}', "华语,雨天,抒情,流行"),
                ("天黑黑", "孙燕姿", "孙燕姿同名专辑", "C-Pop", 2000, '{"duration": "4:23"}', "华语,经典,抒情,流行"),
                ("第一天", "孙燕姿", "Stefanie", "C-Pop", 2004, '{"duration": "4:17"}', "华语,甜美,青春,流行"),
                ("当冬夜渐暖", "孙燕姿", "是时候", "C-Pop", 2011, '{"duration": "4:32"}', "华语,抒情,冬天,流行"),
                ("眼泪成诗", "孙燕姿", "逆光", "C-Pop", 2007, '{"duration": "4:25"}', "华语,抒情,情感,流行"),
                ("我也很想他", "孙燕姿", "逆光", "C-Pop", 2007, '{"duration": "4:05"}', "华语,思念,情歌,流行"),
                ("后来", "刘若英", "我等你", "C-Pop", 1999, '{"duration": "4:39"}', "华语,经典,感伤,流行"),
                ("当爱在靠近", "刘若英", "我等你", "C-Pop", 1999, '{"duration": "4:27"}', "华语,爱情,流行,抒情"),
                ("成全", "刘若英", "我等你", "C-Pop", 1999, '{"duration": "4:15"}', "华语,情感,成全,流行"),
                ("很爱很爱你", "刘若英", "很爱很爱你", "C-Pop", 2000, '{"duration": "4:16"}', "华语,深情,感动,流行"),
                ("一辈子的孤单", "刘若英", "我等你", "C-Pop", 1999, '{"duration": "4:19"}', "华语,孤单,情感,流行"),
                ("这世界那么多人", "莫文蔚", "The Voyage", "C-Pop", 2021, '{"duration": "4:11"}', "华语,深情,感动,流行"),
                ("慢慢喜欢你", "莫文蔚", "回蔚", "C-Pop", 2018, '{"duration": "4:05"}', "华语,甜美,温暖,流行"),
                ("盛夏的果实", "莫文蔚", "i", "C-Pop", 2001, '{"duration": "4:15"}', "华语,感伤,抒情,流行"),
                ("忽然之间", "莫文蔚", "十二楼", "C-Pop", 1999, '{"duration": "4:20"}', "华语,感伤,流行,抒情"),
                ("阴天", "莫文蔚", "i", "C-Pop", 2001, '{"duration": "4:08"}', "华语,抒情,文艺,流行"),
                ("电台情歌", "莫文蔚", "i", "C-Pop", 2001, '{"duration": "4:12"}', "华语,文艺,抒情,流行"),
                ("外面的世界", "莫文蔚", "十二楼", "C-Pop", 1999, '{"duration": "4:03"}', "华语,旅行,抒情,流行"),
                ("他不爱我", "莫文蔚", "十二楼", "C-Pop", 1999, '{"duration": "4:07"}', "华语,失恋,抒情,流行"),
                ("爱", "莫文蔚", "十二楼", "C-Pop", 1999, '{"duration": "4:11"}', "华语,情歌,抒情,流行"),
                ("你在不在", "郭采洁", "烟火", "C-Pop", 2010, '{"duration": "4:09"}', "华语,思念,流行,抒情"),
                ("世界上的另一个我", "郭采洁", "烟火", "C-Pop", 2010, '{"duration": "4:18"}', "华语,抒情,双生,流行"),
                ("在我成为井井有条的大人之前", "郭采洁", "烟火", "C-Pop", 2010, '{"duration": "4:05"}', "华语,成长,文艺,流行"),
                ("狠狠哭", "郭采洁", "烟火", "C-Pop", 2010, '{"duration": "4:12"}', "华语,失恋,宣泄,流行"),
                ("该忘了", "郭采洁", "烟火", "C-Pop", 2010, '{"duration": "4:07"}', "华语,释怀,情感,流行"),
                ("孤独患者", "陈奕迅", "认了吧", "C-Pop", 2007, '{"duration": "4:11"}', "华语,孤独,情感,流行"),
                ("不要说话", "陈奕迅", "认了吧", "C-Pop", 2007, '{"duration": "4:10"}', "华语,抒情,静谧,流行"),
                ("十年", "陈奕迅", "黑·白·灰", "C-Pop", 2003, '{"duration": "4:20"}', "华语,经典,感伤,流行"),
                ("好久不见", "陈奕迅", "认了吧", "C-Pop", 2007, '{"duration": "4:18"}', "华语,思念,抒情,流行"),
                ("淘汰", "陈奕迅", "认了吧", "C-Pop", 2007, '{"duration": "4:15"}', "华语,情感,抒情,流行"),
                ("阴天快乐", "陈奕迅", "认了吧", "C-Pop", 2007, '{"duration": "4:09"}', "华语,治愈,感伤,流行"),
                ("圣诞结", "陈奕迅", "认了吧", "C-Pop", 2007, '{"duration": "4:22"}', "华语,节日,抒情,流行"),
                ("你的背包", "陈奕迅", "黑·白·灰", "C-Pop", 2003, '{"duration": "4:25"}', "华语,旅行,思念,流行"),
                ("谁来剪月光", "陈奕迅", "米·闪", "C-Pop", 2011, '{"duration": "4:13"}', "华语,文艺,感伤,流行"),
                ("如愿", "王菲", "幻乐一场", "C-Pop", 2018, '{"duration": "4:20"}', "华语,深情,抒情,流行"),
                ("红豆", "王菲", "唱游", "C-Pop", 1998, '{"duration": "4:29"}', "华语,经典,情歌,流行"),
                ("百年孤寂", "王菲", "寓言", "C-Pop", 2000, '{"duration": "4:25"}', "华语,文艺,感伤,流行"),
                ("等等", "王菲", "将爱", "C-Pop", 2003, '{"duration": "4:15"}', "华语,抒情,流行,思念"),
                ("美错", "王菲", "寓言", "C-Pop", 2000, '{"duration": "4:22"}', "华语,情感,抒情,流行"),
                ("我愿意", "王菲", "天空", "C-Pop", 1994, '{"duration": "4:08"}', "华语,经典,情歌,流行"),
                ("致青春", "王菲", "将爱", "C-Pop", 2003, '{"duration": "4:12"}', "华语,青春,回忆,流行"),
                ("新的家", "曾轶可", "私奔", "C-Pop", 2011, '{"duration": "4:10"}', "华语,文艺,治愈,流行"),
                ("有可能的夜晚", "曾轶可", "Forever Road", "C-Pop", 2012, '{"duration": "4:08"}', "华语,独立,夜晚,流行"),
                ("夜车", "曾轶可", "私奔", "C-Pop", 2011, '{"duration": "4:11"}', "华语,深夜,旅行,流行"),
                ("我们不是只有现在吗", "曾轶可", "私奔", "C-Pop", 2011, '{"duration": "4:05"}', "华语,青春,思考,流行"),
                ("Forever 21", "曾轶可", "私奔", "C-Pop", 2011, '{"duration": "4:07"}', "华语,青春,自由,流行"),
                ("每个路人熄灭一盏灯", "曾轶可", "私奔", "C-Pop", 2011, '{"duration": "4:13"}', "华语,孤独,夜晚,流行"),
                ("至少还有你", "林忆莲", "林忆莲's", "C-Pop", 2000, '{"duration": "4:20"}', "华语,经典,情歌,抒情"),
                ("词不达意", "林忆莲", "林忆莲's", "C-Pop", 2000, '{"duration": "4:16"}', "华语,情感,抒情,流行"),
                ("为你我受冷风吹", "林忆莲", "都市触觉", "C-Pop", 1990, '{"duration": "4:25"}', "华语,经典,情歌,流行"),
                ("问", "林忆莲", "都市触觉", "C-Pop", 1990, '{"duration": "4:12"}', "华语,深情,感伤,流行"),
                ("当爱已成往事", "林忆莲", "当爱已成往事", "C-Pop", 1993, '{"duration": "4:27"}', "华语,经典,合作,抒情"),
                ("纤维", "林忆莲", "0", "C-Pop", 2000, '{"duration": "4:09"}', "华语,抒情,文艺,流行"),
                ("喜欢", "张悬", "亲爱的…我还不知道", "C-Pop", 2006, '{"duration": "4:00"}', "华语,文艺,抒情,流行"),
                ("宝贝", "张悬", "亲爱的…我还不知道", "C-Pop", 2006, '{"duration": "4:14"}', "华语,温暖,可爱,流行"),
                ("关于我爱你", "张悬", "神的游戏", "C-Pop", 2009, '{"duration": "4:18"}', "华语,情歌,深情,流行"),
                ("艳火", "张悬", "神的游戏", "C-Pop", 2009, '{"duration": "4:12"}', "华语,深情,文艺,流行"),
                ("儿歌", "张悬", "亲爱的…我还不知道", "C-Pop", 2006, '{"duration": "4:06"}', "华语,纯真,回忆,流行"),
                ("南国的孩子", "张悬", "亲爱的…我还不知道", "C-Pop", 2006, '{"duration": "4:11"}', "华语,文艺,淡淡的忧伤,流行"),
                ("喜欢", "张悬", "亲爱的…我还不知道", "C-Pop", 2006, '{"duration": "4:00"}', "华语,文艺,抒情,流行"),
                ("当时的月亮", "张悬", "神的游戏", "C-Pop", 2009, '{"duration": "4:13"}', "华语,经典,温柔,流行"),
                ("如果你也听说", "张惠妹", "AMIT", "C-Pop", 2009, '{"duration": "4:19"}', "华语,深情,流行,抒情"),
                ("人质", "张惠妹", "我要快乐？", "C-Pop", 2004, '{"duration": "4:25"}', "华语,情歌,经典,流行"),
                ("记得", "张惠妹", "你在看我吗", "C-Pop", 2001, '{"duration": "4:20"}', "华语,情歌,抒情,流行"),
                ("我最亲爱的", "张惠妹", "偏执面", "C-Pop", 2011, '{"duration": "4:17"}', "华语,思念,抒情,流行"),
                ("连名带姓", "张惠妹", "偏执面", "C-Pop", 2011, '{"duration": "4:09"}', "华语,深情,感伤,流行"),
                ("掉了", "张惠妹", "我要快乐？", "C-Pop", 2004, '{"duration": "4:06"}', "华语,失恋,情感,流行"),
                ("趁早", "张惠妹", "真实", "C-Pop", 2001, '{"duration": "4:16"}', "华语,放下,洒脱,流行"),
                ("虚拟", "陈粒", "如也", "独立民谣", 2015, '{"duration": "4:15"}', "华语,独立,民谣,流行"),
                ("半", "陈粒", "如也", "独立民谣", 2015, '{"duration": "4:13"}', "华语,深情,诗意,流行"),
                ("走马", "陈粒", "如也", "独立民谣", 2015, '{"duration": "4:19"}', "华语,旅行,自由,流行"),
                ("易燃易爆炸", "陈粒", "如也", "独立民谣", 2015, '{"duration": "4:12"}', "华语,激烈,情感,流行"),
                ("奇妙能力歌", "陈粒", "如也", "独立民谣", 2015, '{"duration": "4:14"}', "华语,文艺,灵气,流行"),
                ("光", "陈粒", "如也", "独立民谣", 2015, '{"duration": "4:09"}', "华语,希望,抒情,流行"),
                ("绝对占有相对自由", "陈粒", "如也", "独立民谣", 2015, '{"duration": "4:07"}', "华语,自由,探讨,流行"),
                ("历历万乡", "陈粒", "如也", "独立民谣", 2015, '{"duration": "4:10"}', "华语,旅行,乡愁,流行"),
                ("桥豆麻袋", "陈粒", "如也", "独立民谣", 2015, '{"duration": "3:58"}', "华语,俏皮,文艺,流行"),
                ("妙龄童", "陈粒", "如也", "独立民谣", 2015, '{"duration": "4:05"}', "华语,青春,洒脱,流行"),
                ("祝星", "陈粒", "如也", "独立民谣", 2015, '{"duration": "4:11"}', "华语,星光,诗意,流行"),
                ("My Dear Art", "陈粒", "如也", "独立民谣", 2015, '{"duration": "4:16"}', "华语,英文,文艺,流行"),
                ("你曾是少年", "S.H.E", "花又开好了", "C-Pop", 2012, '{"duration": "4:07"}', "华语,青春,励志,流行"),
                ("安静了", "S.H.E", "花又开好了", "C-Pop", 2012, '{"duration": "4:10"}', "华语,抒情,安静,流行"),
                ("一眼万年", "S.H.E", "Play", "C-Pop", 2007, '{"duration": "4:15"}', "华语,情歌,宿命,流行"),
                ("五月天", "S.H.E", "Play", "C-Pop", 2007, '{"duration": "4:09"}', "华语,合作,青春,流行"),
                ("谢谢你的温柔", "S.H.E", "Play", "C-Pop", 2007, '{"duration": "4:11"}', "华语,感谢,情感,流行"),
                ("他还是不懂", "S.H.E", "Play", "C-Pop", 2007, '{"duration": "4:08"}', "华语,失恋,遗憾,流行"),
                ("两个人的荒岛", "S.H.E", "花又开好了", "C-Pop", 2012, '{"duration": "4:12"}', "华语,情感,孤独,流行"),
                ("沿海公路的出口", "S.H.E", "花又开好了", "C-Pop", 2012, '{"duration": "4:03"}', "华语,旅行,流行,治愈"),
                ("热带雨林", "S.H.E", "女生宿舍", "C-Pop", 2001, '{"duration": "4:06"}', "华语,自然,情感,流行"),
                ("候鸟", "S.H.E", "Play", "C-Pop", 2007, '{"duration": "4:10"}', "华语,漂泊,自由,流行"),
                ("怎么办", "S.H.E", "Play", "C-Pop", 2007, '{"duration": "4:04"}', "华语,爱情,选择,流行"),
                ("紫藤花", "S.H.E", "Play", "C-Pop", 2007, '{"duration": "4:16"}', "华语,花,情感,流行"),
                ("612星球", "S.H.E", "Play", "C-Pop", 2007, '{"duration": "4:18"}', "华语,幻想,科幻,流行"),
                ("Ring Ring Ring", "S.H.E", "Play", "C-Pop", 2007, '{"duration": "4:05"}', "华语,青春,活力,流行"),
                ("给电影人的情书", "五月天", "自传", "C-Pop", 2016, '{"duration": "4:30"}', "华语,情感,流行"),
                ("青春纪念册", "可米小子", "青春纪念册", "C-Pop", 2003, '{"duration": "4:20"}', "华语,青春,怀旧,流行"),
                ("苦茶", "张韶涵", "欧若拉", "C-Pop", 2004, '{"duration": "4:15"}', "华语,情感,流行"),
                ("恶作剧", "王蓝茵", "恶作剧之吻 电视原声带", "C-Pop", 2005, '{"duration": "4:05"}', "华语,青春,流行"),
                ("给我一个理由忘记", "A-Lin", "失恋无罪", "C-Pop", 2010, '{"duration": "4:25"}', "华语,情感,流行"),
                ("蝴蝶泉边", "黄雅莉", "崽崽", "C-Pop", 2005, '{"duration": "4:10"}', "华语,自然,流行"),
                ("童话", "光良", "童话", "C-Pop", 2005, '{"duration": "4:30"}', "华语,情感,经典,流行"),
                ("越长大越孤单", "牛奶咖啡", "越长大越孤单", "C-Pop", 2008, '{"duration": "4:20"}', "华语,成长,流行"),
                ("小宇", "张震岳", "秘密基地", "C-Pop", 2003, '{"duration": "4:00"}', "华语,情感,流行"),
                ("春泥", "庾澄庆", "哈林天堂", "C-Pop", 2004, '{"duration": "4:15"}', "华语,励志,流行"),
                ("莉莉安", "宋冬野", "安和桥北", "民谣", 2013, '{"duration": "4:40"}', "华语,民谣,流行"),
                ("爱的魔法", "金莎", "空气", "C-Pop", 2005, '{"duration": "4:05"}', "华语,甜美,流行"),
                ("苏州河", "朴树", "我去2000年", "C-Pop", 1999, '{"duration": "4:20"}', "华语,文艺,流行"),
                ("普通到不普通的人生", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:30"}', "华语,人生,流行"),
                ("这条小鱼在乎", "梁静茹", "燕尾蝶", "C-Pop", 2004, '{"duration": "4:10"}', "华语,情感,流行"),
                ("银河", "陈绮贞", "太阳", "独立民谣", 2014, '{"duration": "4:25"}', "华语,文艺,流行"),
                ("大梦", "赵雷", "无法长大", "民谣", 2016, '{"duration": "4:35"}', "华语,梦想,流行"),
                ("乌梅子酱", "李荣浩", "耳朵", "C-Pop", 2018, '{"duration": "4:15"}', "华语,甜美,流行"),
                ("指纹", "范玮琪", "哲学家", "C-Pop", 2006, '{"duration": "4:20"}', "华语,情感,流行"),
                ("断点", "张敬轩", "My Way", "C-Pop", 2004, '{"duration": "4:10"}', "华语,情感,流行"),
                ("米店", "张悬", "My Life Will...", "独立民谣", 2006, '{"duration": "4:30"}', "华语,文艺,流行"),
                ("单身旅记", "陈绮贞", "太阳", "独立民谣", 2014, '{"duration": "4:20"}', "华语,旅行,流行"),
                ("什么", "五月天", "自传", "C-Pop", 2016, '{"duration": "4:15"}', "华语,思考,流行"),
                ("想念拟人化", "蔡健雅", "Goodbye & Hello", "C-Pop", 2007, '{"duration": "4:25"}', "华语,情感,流行"),
                ("像你这样的朋友", "蔡健雅", "Goodbye & Hello", "C-Pop", 2007, '{"duration": "4:05"}', "华语,友情,流行"),
                ("鲜花", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:20"}', "华语,情感,流行"),
                ("低语", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:15"}', "华语,情感,流行"),
                ("美好的事情能不能发生在我身上", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:30"}', "华语,希望,流行"),
                ("小王", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:10"}', "华语,情感,流行"),
                ("淡季动物园", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:25"}', "华语,文艺,流行"),
                ("悬日", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:35"}', "华语,情感,流行"),
                ("苹果", "范玮琪", "哲学家", "C-Pop", 2006, '{"duration": "4:10"}', "华语,情感,流行"),
                ("Melody", "陶喆", "太平盛世", "C-Pop", 2005, '{"duration": "4:20"}', "华语,情感,流行"),
                ("山海", "草东没有派对", "丑奴儿", "独立摇滚", 2016, '{"duration": "5:00"}', "华语,摇滚,流行"),
                ("我用什么把你留住", "张学友", "在你身边", "C-Pop", 2004, '{"duration": "4:25"}', "华语,情感,流行"),
                ("形容", "蔡健雅", "Goodbye & Hello", "C-Pop", 2007, '{"duration": "4:15"}', "华语,情感,流行"),
                ("色盲", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:30"}', "华语,情感,流行"),
                ("阳光下的星星", "张韶涵", "欧若拉", "C-Pop", 2004, '{"duration": "4:05"}', "华语,励志,流行"),
                ("告白", "周杰伦", "范特西", "C-Pop", 2001, '{"duration": "4:10"}', "华语,情感,流行"),
                ("爱人", "张信哲", "信仰", "C-Pop", 2000, '{"duration": "4:20"}', "华语,情感,流行"),
                ("找到你是我最伟大的成功", "林俊杰", "因你而在", "C-Pop", 2013, '{"duration": "4:35"}', "华语,情感,流行"),
                ("如果这都不算爱", "张学友", "在你身边", "C-Pop", 2004, '{"duration": "4:25"}', "华语,情感,流行"),
                ("粉末", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:15"}', "华语,情感,流行"),
                ("迷人的危险", "张韶涵", "欧若拉", "C-Pop", 2004, '{"duration": "4:10"}', "华语,情感,流行"),
                ("渡口", "蔡健雅", "Goodbye & Hello", "C-Pop", 2007, '{"duration": "4:20"}', "华语,情感,流行"),
                ("夏天", "周杰伦", "范特西", "C-Pop", 2001, '{"duration": "4:05"}', "华语,青春,流行"),
                ("杀死那个石家庄人", "万能青年旅店", "万能青年旅店", "独立摇滚", 2010, '{"duration": "5:30"}', "华语,摇滚,流行"),
                ("关于青春", "五月天", "自传", "C-Pop", 2016, '{"duration": "4:15"}', "华语,青春,流行"),
                ("眼泪的错觉", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:25"}', "华语,情感,流行"),
                ("Lolita", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:10"}', "华语,情感,流行"),
                ("新娘阿花", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:20"}', "华语,情感,流行"),
                ("孤独她呀", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:15"}', "华语,情感,流行"),
                ("会痛的石头", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:30"}', "华语,情感,流行"),
                ("我以为", "杨宗纬", "原色", "C-Pop", 2011, '{"duration": "4:25"}', "华语,情感,流行"),
                ("故梦", "许嵩", "寻雾启示", "C-Pop", 2014, '{"duration": "4:35"}', "华语,情感,流行"),
                ("如果我变成回忆", "Tank", "延长比赛", "C-Pop", 2007, '{"duration": "4:20"}', "华语,情感,流行"),
                ("我的一个道姑朋友", "许嵩", "寻雾启示", "C-Pop", 2014, '{"duration": "4:30"}', "华语,情感,流行"),
                ("真相是真", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:10"}', "华语,情感,流行"),
                ("可乐", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:20"}', "华语,情感,流行"),
                ("爱恨恢恢", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:15"}', "华语,情感,流行"),
                ("缺席", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:30"}', "华语,情感,流行"),
                ("蜜蜂demo", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:25"}', "华语,情感,流行"),
                ("梦里的声音", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:35"}', "华语,情感,流行"),
                ("唯一", "王力宏", "唯一", "C-Pop", 2001, '{"duration": "4:10"}', "华语,情感,流行"),
                ("秘密", "林宥嘉", "神秘嘉宾", "C-Pop", 2008, '{"duration": "4:20"}', "华语,情感,流行"),
                ("放弃爱你", "范玮琪", "哲学家", "C-Pop", 2006, '{"duration": "4:15"}', "华语,情感,流行"),
                ("我爱他", "丁当", "夜猫", "C-Pop", 2009, '{"duration": "4:30"}', "华语,情感,流行"),
                ("凄美地", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:25"}', "华语,情感,流行"),
                ("谁", "陈奕迅", "米·闪", "C-Pop", 2008, '{"duration": "4:35"}', "华语,情感,流行"),
                ("下雨天", "南拳妈妈", "优の良曲 南搞小孩", "C-Pop", 2005, '{"duration": "4:10"}', "华语,情感,流行"),
                ("画心", "张靓颖", "画皮 电影原声带", "C-Pop", 2008, '{"duration": "4:20"}', "华语,情感,流行"),
                ("下一个天亮", "郭静", "在树上唱歌", "C-Pop", 2008, '{"duration": "4:15"}', "华语,情感,流行"),
                ("天后", "陈势安", "天后", "C-Pop", 2009, '{"duration": "4:30"}', "华语,情感,流行"),
                ("明天你好", "牛奶咖啡", "明天，你好", "C-Pop", 2011, '{"duration": "4:25"}', "华语,励志,流行"),
                ("月牙湾", "飞儿乐团", "爱·歌姬", "C-Pop", 2007, '{"duration": "4:35"}', "华语,情感,流行"),
                ("青柠", "徐佳莹", "极限", "C-Pop", 2010, '{"duration": "4:10"}', "华语,情感,流行"),
                ("年少有为", "李荣浩", "耳朵", "C-Pop", 2018, '{"duration": "4:20"}', "华语,情感,流行"),
                ("飞云之下", "韩红", "飞云之下", "C-Pop", 2018, '{"duration": "4:15"}', "华语,情感,流行")
            ]
        
            cur.executemany("""
            INSERT INTO songs (title, artist, album, genre, year, meta_data, tags)
            VALUES (?, ?, ?, ?, ?, ?, ?)
            """, example_songs)
            conn.commit()
    
        conn.close()

# 创建默认数据库实例
db = Database()

# 提供简便的访问方法，便于从其他模块调用
def get_connection():
    """获取数据库连接"""
    return db.get_connection()

def init_db(reset=False):
    """初始化数据库"""
    db.init_db(reset)
